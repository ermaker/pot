<source>
  @type udp
  tag set_tag.remove_tag
  source_hostname_key host
  message_length_limit 1MB
  <parse>
    @type json
    time_key @timestamp
    time_type string
  </parse>
</source>

<source>
  @type tcp
  tag set_tag.remove_tag
  source_hostname_key host
  <parse>
    @type json
    time_key @timestamp
    time_type string
  </parse>
</source>

<match set_tag.**>
  @type rewrite_tag_filter
  remove_tag_prefix set_tag

  <rule>
    key tag
    pattern /^(.*)$/
    tag ${tag}.$1
  </rule>

  <rule>
    key message
    pattern //
    tag ${tag}.raw
  </rule>
</match>

<match remove_tag.**>
  @type record_reformer
  remove_keys tag
  tag ${tag_suffix[1]}
</match>

<filter json.**>
  @type parser
  key_name message
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

<match json.**>
  @type record_reformer
  tag ${tag_suffix[1]}
</match>

# <filter **>
#   @type stdout
# </filter>

<match **>
  @type elasticsearch
  hosts http://elasticsearch:9200
  logstash_format true
  logstash_prefix fluentd
  type_name doc
  # reload_connections false

  <buffer>
    # @type file
    @type memory
    # path /fluentd/log
    # flush_mode immediate
  </buffer>
</match>
